"use strict";$(function(){var a,b="jobs-on-fire",c=window.firebase=new Firebase("https://"+b+".firebaseio.com/");c.onAuth(function(a){a?$(".logout").removeClass("hide"):$(".logout").addClass("hide")});var d=function(a){return _.reduce(_.map(a,function(a,b){var c={};return c[b]=_.isString(a)?_.escape(a):a,c}),function(a,b){return _.extend(a,b)},{})};Backbone.Form.template=_.template('<form class="form-horizontal" role="form" data-fieldsets></form>'),Backbone.Form.Fieldset.template=_.template("<fieldset data-fields><% if (legend) { %><legend><%= legend %></legend><% } %></fieldset>"),Backbone.Form.Field.template=_.template('<div class="form-group field-<%= key %>"><label class="col-sm-2 control-label" for="<%= editorId %>"><%= title %></label><div class="col-sm-10"><span data-editor></span><p class="help-block" data-error></p><p class="help-block"><%= help %></p></div></div>'),Backbone.Form.NestedField.template=_.template('<div class="field-<%= key %>"><div title="<%= title %>" class="input-xlarge"><span data-editor></span><div class="help-inline" data-error></div></div><div class="help-block"><%= help %></div></div>'),Backbone.Form.editors.Base.prototype.className="form-control",Backbone.Form.editors.Radio.prototype.className="radio",Backbone.Form.editors.Checkbox.prototype.className="checkbox",Backbone.Form.Field.errorClassName="has-error",Backbone.Form.validators.errMessages.required="Obligatorio",Backbone.Form.validators.errMessages.email="Debe indicar un correo electrónico válido";var e={title:{title:"Título de la Oferta",type:"Text",validators:["required"]},expires:{title:"Fecha de Expiración",type:"Date",validators:["required"]},location:{title:"Ubicación",type:"Text",validators:[function(a,b){return b.remote||a?null:{type:"location",message:"Debes indicar una ubicación si el empleo no es remoto"}}]},remote:{title:"Remoto?",type:"Checkbox"},workingTime:{title:"Horario de Trabajo",type:"Radio",options:["A convenir","Medio Tiempo","Tiempo Completo"]},description:{title:"Descripción",type:"TextArea",validators:["required",function(a){return a.length<140?{type:"description",message:"La descripción es muy corta. Debe ser de 140 caracteres o más."}:null}]},publisher:{title:"Publicado por",type:"Text",validators:["required"]},email:{title:"Correo de contacto",type:"Text",dataType:"email",validators:["email",function(a,b){return a||b.url?null:{type:"email",message:"Es necesario un correo electrónico o una URL de aplicación"}}]},url:{title:"URL de aplicación",type:"Text",dataType:"url",validators:[function(a,b){return a||b.email?null:{type:"url",message:"Es necesario un correo electrónico o una URL de aplicación"}}]}},f=Backbone.Model.extend({}),g=Backbone.Firebase.Collection.extend({model:f,firebase:c.child("jobs"),active:function(){return this.filter(function(a){return new Date(a.expires)>new Date})}}),h=Backbone.View.extend({tagName:"li",template:_.template($("#job_template").text()),events:{"click .job-delete":"remove"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){var a=d(this.model.toJSON());return this.$el.html(this.template(a)),this},remove:function(b){b.preventDefault(),a.remove(this.model)}}),i=Backbone.View.extend({el:$("#login_or_register_body"),events:{"click #login_or_register_fb":"fbLogin","click #login_or_register_tw":"twLogin","click #login_or_register_gh":"ghLogin","click #login_or_register_go":"goLogin"},initialize:function(){this.users=c.child("users")},genericLogin:function(a,b){a?(this.$el.prepend('<p class="text-danger">No se pudo ingresar</p>'),c.child("errors").push(a)):(this.users.child(b.uid).set(b),$("#login_or_register_modal").modal("hide"))},fbLogin:function(a){a.preventDefault(),a.stopPropagation(),this.users.authWithOAuthPopup("facebook",_.bind(this.genericLogin,this))},twLogin:function(a){a.preventDefault(),a.stopPropagation(),this.users.authWithOAuthPopup("twitter",_.bind(this.genericLogin,this))},ghLogin:function(a){a.preventDefault(),a.stopPropagation(),this.users.authWithOAuthPopup("github",_.bind(this.genericLogin,this))},goLogin:function(a){a.preventDefault(),a.stopPropagation(),this.users.authWithOAuthPopup("google",_.bind(this.genericLogin,this))}}),j=Backbone.View.extend({el:$("#add_job_content"),events:{"click #add_job_button":"addJob"},initialize:function(a){this.jobs=a.jobs},render:function(){this.form=new Backbone.Form({schema:e,data:{expires:Date.now().valueOf()+1296015e3,remote:!1,workingTime:"A convenir"}}),this.$(".add-job-form").html(this.form.render().el)},addJob:function(){var a,b,c,e;this.form.validate()||(a=d(this.form.getValue()),c=this.jobs.firebase.getAuth(),e=Date.now().valueOf(),a.expires=a.expires.valueOf(),b=_.defaults(a,{userId:c?c.uid:"",posted:e,updated:e,expires:e+1296015e3}),this.jobs.add(b),$("#add_job_modal").modal("hide"))}}),k=Backbone.View.extend({el:$("#jobs_on_fire"),events:{"click #add_job":"addJobDialog","click #logout_link":"logout"},initialize:function(a){this.jobs=a.jobs,this.list=this.$("#jobs .jobs-list"),this.listenTo(this.jobs,"add",this.addOne),this.listenTo(this.jobs,"remove",this.removeOne)},addOne:function(a){var b=new h({model:a});this.list.append(b.render().el)},removeOne:function(a){this.$("#job_"+a.id).remove()},addJobDialog:function(a){a.preventDefault(),a.stopPropagation();var b=this.jobs.firebase.getAuth();b?(new j({jobs:this.jobs}).render(),this.$("#add_job_modal").modal()):(new i({firebase:this.jobs.firebase}).render(),this.$("#login_or_register_modal").modal())},logout:function(a){a.preventDefault(),a.stopPropagation(),this.jobs.firebase.unauth()}});a=new g,new k({jobs:a})});